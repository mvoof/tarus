name: Publish Extension

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    name: Build Server (${{ matrix.target.os }})
    runs-on: ${{ matrix.target.os }}
    strategy:
      matrix:
        target:
          - os: ubuntu-latest
            rust-target: x86_64-unknown-linux-gnu
            binary-name: lsp-server-linux-x64
          - os: windows-latest
            rust-target: x86_64-pc-windows-msvc
            binary-name: lsp-server-win-x64.exe
          - os: macos-latest
            rust-target: x86_64-apple-darwin
            binary-name: lsp-server-macos-x64
          - os: macos-latest
            rust-target: aarch64-apple-darwin
            binary-name: lsp-server-macos-arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.target.rust-target }}

      - name: Build Rust Binary
        run: |
          cd lsp-server
          cargo build --release --target ${{ matrix.target.rust-target }}

      - name: Rename Binary
        shell: bash
        run: |
          if [ "${{ matrix.target.os }}" = "windows-latest" ]; then
            mv lsp-server/target/${{ matrix.target.rust-target }}/release/lsp-server.exe ${{ matrix.target.binary-name }}
          else
            mv lsp-server/target/${{ matrix.target.rust-target }}/release/lsp-server ${{ matrix.target.binary-name }}
          fi

      - name: Upload Binary Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target.binary-name }}
          path: ${{ matrix.target.binary-name }}

  publish:
    name: Publish VS Code Extension
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: extension/package-lock.json

      - name: Download all Artifacts
        uses: actions/download-artifact@v4
        with:
          path: compiled-binaries

      - name: Prepare Binaries and Config
        run: |
          mkdir -p extension/bin


          cp compiled-binaries/lsp-server-linux-x64/lsp-server-linux-x64 extension/bin/
          cp compiled-binaries/lsp-server-win-x64.exe/lsp-server-win-x64.exe extension/bin/
          cp compiled-binaries/lsp-server-macos-x64/lsp-server-macos-x64 extension/bin/
          cp compiled-binaries/lsp-server-macos-arm64/lsp-server-macos-arm64 extension/bin/


          chmod +x extension/bin/lsp-server-linux-x64
          chmod +x extension/bin/lsp-server-macos-x64
          chmod +x extension/bin/lsp-server-macos-arm64

          cp lsp-server/command_syntax.json extension/bin/command_syntax.json
          cp README.md extension/README.md
          cp CHANGELOG.md extension/CHANGELOG.md
          cp LICENSE extension/LICENSE || echo "License file not found, skipping"

      - name: Install Dependencies & Modify Scripts
        run: |
          cd extension
          npm ci
          npm pkg set scripts.vscode:prepublish="npm run compile-client"

      - name: Publish to Visual Studio Marketplace
        uses: HaaLeo/publish-vscode-extension@v2
        with:
          pat: ${{ secrets.VS_MARKETPLACE_TOKEN }}
          registryUrl: https://marketplace.visualstudio.com
          packagePath: extension

      - name: Publish to Open VSX Registry
        if: env.OPEN_VSX_TOKEN != ''
        uses: HaaLeo/publish-vscode-extension@v2
        with:
          pat: ${{ secrets.OPEN_VSX_TOKEN }}
          packagePath: extension
